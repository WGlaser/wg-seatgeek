definitions:
  work_pools:
    central-push-pool: &central-push-pool
      name: central-push-pool
      job_variables:
        image: us-central1-docker.pkg.dev/wade-prefect/prefect-images/prefect-flows/wg-seatgeek
        memory: 1024Mi
  actions:
    build:
      - prefect.deployments.steps.run_shell_script:
          id: get-commit-hash
          script: git rev-parse --short HEAD
          stream_output: false
      - prefect_docker.deployments.steps.build_docker_image:
          id: build-image
          requires: prefect-docker
          image_name: us-central1-docker.pkg.dev/wade-prefect/prefect-images/prefect-flows/wg-seatgeek
          tag: "{{ get-commit-hash.stdout }}"
          dockerfile: Dockerfile
          platform: linux/amd64
          buildargs:
            AUTHED_ARTIFACT_REG_URL: https://_json_key_base64:{{ $secrets.CENTRAL_INFRA_SA_JSON_64 }}@uus-central1-python.pkg.dev/wade-prefect/private-packages/simple/
      - prefect_docker.deployments.steps.build_docker_image:
          id: build-image-latest
          requires: prefect-docker
          image_name: us-central1-docker.pkg.dev/wade-prefect/prefect-images/prefect-flows/wg-seatgeek
          tag: latest
          dockerfile: Dockerfile
          platform: linux/amd64
          buildargs:
            AUTHED_ARTIFACT_REG_URL: https://_json_key_base64:{{ $secrets.CENTRAL_INFRA_SA_JSON_64 }}@us-central1-python.pkg.dev/wade-prefect/private-packages/simple/
    push:
      - prefect_docker.deployments.steps.push_docker_image:
          requires: prefect-docker
          image_name: "{{build-image.image_name}}"
          tag: "{{ build-image.tag }}"
      - prefect_docker.deployments.steps.push_docker_image:
          requires: prefect-docker
          image_name: "{{build-image.image_name}}"
          tag: latest
    pull:
      - prefect.deployments.steps.git_clone:
          repository: https://github.com/WGlaser/wg-seatgeek.git
          branch: main
          credentials: "{{ prefect.blocks.github-credentials.wg-github-credentials }}"
  deployments:
  - name: wg-seatgeek-celtics
    tags: [seatgeek, celtics]
    entrypoint: wg_seatgeek/wg_seatseek.py:wg_seatgeek
    parameters:
      team: Boston-Celtics
    work_pool: *central-push-pool

  - name: wg-seatgeek-nuggets
    tags: [seatgeek, nuggets]
    entrypoint: wg_seatgeek/wg_seatseek.py:wg_seatgeek
    parameters:
      team: Denver-Nuggets
    work_pool: *central-push-pool

# Generic metadata about this project
name: wg_seatgeek
prefect-version: 2.17

# build section allows you to manage and build docker images
build:

# push section allows you to manage if and how this project is uploaded to remote locations
push:

# pull section allows you to provide instructions for cloning this project in remote locations
pull:

# the deployments section allows you to provide configuration for deploying flows
deployments: